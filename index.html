
<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø¨ÛŒØª Ù…Ø§Ø±Ú©Øª - Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² ØµØ±Ø§ÙÛŒ</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-sm font-sans">

<header class="bg-gray-800 text-white flex justify-between items-center px-4 py-2">
  <h1 class="text-lg font-bold">ØµØ±Ø§ÙÛŒ Ø¨ÛŒØª Ù…Ø§Ø±Ú©Øª</h1>
  <button onclick="toggleProfile()" class="w-8 h-8 rounded-full bg-white text-gray-800 flex items-center justify-center font-bold text-sm">ğŸ‘¤</button>
</header>


<div id="profileBox" class="hidden fixed top-16 right-4 bg-white border shadow-xl rounded-xl w-80 p-4 z-50 text-sm">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-lg font-bold text-gray-800">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ</h2>
    <button onclick="toggleProfile()" class="text-gray-400 hover:text-red-500 text-lg font-semibold">âœ–</button>
  </div>
  <div class="grid grid-cols-2 gap-4 text-gray-700">
    <div class="bg-gray-50 p-3 rounded shadow-sm">
      <div class="text-xs text-gray-500">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±</div>
      <div class="font-medium">Ú©Ø§Ø±Ø¨Ø± ØµØ±Ø§ÙÛŒ</div>
    </div>
    <div class="bg-gray-50 p-3 rounded shadow-sm">
      <div class="text-xs text-gray-500">ÙˆØ¶Ø¹ÛŒØª ÙˆØ±ÙˆØ¯</div>
      <div class="font-medium">ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡</div>
    </div>
    <div class="bg-gray-50 p-3 rounded shadow-sm col-span-2">
      <div class="text-xs text-gray-500">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ù„ (ØªÙˆÙ…Ø§Ù†)</div>
      <div class="font-bold text-green-700 text-lg" id="balanceToman">0</div>
    </div>
    <div class="bg-gray-50 p-3 rounded shadow-sm col-span-2">
      <div class="text-xs text-gray-500">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¯Ù„Ø§Ø±ÛŒ</div>
      <div class="font-medium" id="balanceDollar">0 Ø¯Ù„Ø§Ø±</div>
    </div>
    <div class="bg-gray-50 p-3 rounded shadow-sm">
      <div class="text-xs text-gray-500">ØªØ¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª</div>
      <div class="font-medium" id="tradeCount">0</div>
    </div>
    <div class="bg-gray-50 p-3 rounded shadow-sm">
      <div class="text-xs text-gray-500">Ø³ÙˆØ¯ Ùˆ Ø²ÛŒØ§Ù†</div>
      <div class="font-medium" id="totalPnL">0</div>
    </div>
  </div>
</div>


<div class="p-4">
  <h2 class="font-semibold mb-2 text-gray-800">Ø¨Ø§Ø²Ø§Ø± Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ</h2>
  <table class="w-full bg-white rounded shadow text-center">
    <thead class="bg-gray-100"><tr><th class="p-2">Ø§Ø±Ø²</th><th>Ù‚ÛŒÙ…Øª</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead>
    <tbody id="market-body"></tbody>
  </table>
</div>

<div class="p-4">
  <h2 class="font-semibold mb-2 text-gray-800">Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</h2>
  <table class="w-full bg-white rounded shadow text-center">
    <thead class="bg-gray-100"><tr><th>Ø§Ø±Ø²</th><th>Ù…Ù‚Ø¯Ø§Ø±</th><th>Ø§Ø±Ø²Ø´ ØªÙˆÙ…Ø§Ù†ÛŒ</th><th>Ø³ÙˆØ¯ Ùˆ Ø²ÛŒØ§Ù†</th></tr></thead>
    <tbody id="wallet-body"></tbody>
  </table>
</div>

<div class="p-4">
  <div class="flex justify-between mb-2">
    <h2 class="font-semibold text-gray-800">Ø¯ÙØªØ± Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h2>
    <button onclick="showResetConfirm()" class="bg-gray-200 px-2 py-1 rounded text-xs">Ø±ÛŒØ³Øª</button>
  </div>
  <table class="w-full bg-white rounded shadow text-center">
    <thead class="bg-gray-100"><tr><th>Ø²Ù…Ø§Ù†</th><th>Ø§Ø±Ø²</th><th>Ù†ÙˆØ¹</th><th>Ù…Ù‚Ø¯Ø§Ø±</th><th>Ù‚ÛŒÙ…Øª</th></tr></thead>
    <tbody id="history-body"></tbody>
  </table>
</div>

<!-- Modal Ø®Ø±ÛŒØ¯/ÙØ±ÙˆØ´ -->
<div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-50">
  <div class="bg-white p-4 rounded w-80">
    <h3 id="modal-title" class="text-lg font-semibold mb-2"></h3>
    <input id="modal-input" type="number" class="w-full border p-2 rounded mb-2" placeholder="Ù…Ù‚Ø¯Ø§Ø± ÛŒØ§ Ù…Ø¨Ù„Øº">
    <input id="percent-slider" type="range" min="1" max="100" class="w-full mb-1">
    <p id="modal-extra" class="text-xs text-gray-600 mb-1"></p>
    <p id="modal-note" class="text-xs text-red-600 mb-1 hidden">Ø­Ø¯Ø§Ù‚Ù„ Ù…Ø¨Ù„Øº Ø®Ø±ÛŒØ¯ Û±Û°Û°,Û°Û°Û° ØªÙˆÙ…Ø§Ù† Ø§Ø³Øª</p>
    <div class="flex justify-between gap-2">
      <button onclick="confirmModal()" class="bg-green-500 text-white px-4 py-1 rounded w-full">ØªØ£ÛŒÛŒØ¯</button>
      <button onclick="closeModal()" class="bg-gray-200 text-gray-800 px-4 py-1 rounded w-full">Ù„ØºÙˆ</button>
    </div>
  </div>
</div>

<!-- Ù¾Ù†Ù„ Ø±ÛŒØ³Øª Ø¯ÙØªØ± Ù…Ø¹Ø§Ù…Ù„Ø§Øª -->
<div id="confirm-reset-box" class="hidden fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-50">
  <div class="bg-white p-4 rounded shadow w-72">
    <p class="text-sm text-gray-800 mb-4">Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¯ÙØªØ± Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø±Ø§ Ø±ÛŒØ³Øª Ú©Ù†ÛŒØ¯ØŸ</p>
    <div class="flex gap-2">
      <button onclick="confirmReset()" class="bg-red-500 text-white w-full rounded py-1">Ø¨Ù„Ù‡</button>
      <button onclick="closeConfirmReset()" class="bg-gray-200 text-gray-800 w-full rounded py-1">Ù„ØºÙˆ</button>
    </div>
  </div>
</div>

<script>
const coins = [
  { name: 'BTC', price: 6000000000 },
  { name: 'ETH', price: 300000000 },
  { name: 'USDT', price: 80000 },
  { name: 'XRP', price: 300000 }
];

function simulateTimeBasedFluctuation() {
  for (let c of coins) {
    const rand = 1 + (Math.random() - 0.5) * 0.02; // Â±2% Ù†ÙˆØ³Ø§Ù†
    c.price = Math.round(c.price * rand);
  }
}

function applyTimeBasedFluctuation() {
  const lastVisit = Number(localStorage.getItem('lastVisit')) || Date.now();
  const now = Date.now();
  const minutesPassed = Math.floor((now - lastVisit) / 60000);
  for (let i = 0; i < minutesPassed; i++) {
    simulateTimeBasedFluctuation();
  }
  localStorage.setItem('lastVisit', now);
}


let wallet = JSON.parse(localStorage.getItem('wallet') || '{}');
let history = JSON.parse(localStorage.getItem('history') || '[]');
let balance = Number(localStorage.getItem('balance') || 100000000);
let isBuy = true, currentCoin = '', currentPrice = 0;

function toggleProfile() {
  const box = document.getElementById('profileBox');
  box.classList.toggle('hidden');
  if (!box.classList.contains('hidden')) {
    const usdt = coins.find(c => c.name === 'USDT').price;
    const totalPnL = coins.reduce((acc, c) => acc + calculatePnL(c.name, c.price), 0);
    document.getElementById('balanceToman').textContent = balance.toLocaleString();
    document.getElementById('balanceDollar').textContent = (balance / usdt).toFixed(2);
    document.getElementById('tradeCount').textContent = history.length;
    document.getElementById('totalPnL').textContent =
      (totalPnL >= 0 ? '+' : '') + totalPnL.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†';
  }
}

function renderMarket() {
  const tbody = document.getElementById('market-body');
  tbody.innerHTML = '';
  coins.forEach(c => {
    tbody.innerHTML += `<tr>
      <td class="p-2">${c.name}</td>
      <td>${c.price.toLocaleString()}</td>
      <td>
        <button onclick="openModal('${c.name}', ${c.price}, true)" class="bg-green-500 text-white text-xs px-3 py-1 rounded">Ø®Ø±ÛŒØ¯</button>
        <button onclick="openModal('${c.name}', ${c.price}, false)" class="bg-red-500 text-white text-xs px-3 py-1 rounded">ÙØ±ÙˆØ´</button>
      </td>
    </tr>`;
  });
}

function renderWallet() {
  const tbody = document.getElementById('wallet-body');
  tbody.innerHTML = '';
  coins.forEach(c => {
    const qty = wallet[c.name] || 0;
    const value = qty * c.price;
    const pnl = calculatePnL(c.name, c.price);
    const pnlColor = pnl > 0 ? 'text-green-600' : pnl < 0 ? 'text-red-600' : '';
    tbody.innerHTML += `<tr>
      <td class="p-2">${c.name}</td>
      <td>${qty.toFixed(4)}</td>
      <td>${value.toLocaleString()} ØªÙˆÙ…Ø§Ù†</td>
      <td class="${pnlColor}">${pnl >= 0 ? '+' : ''}${pnl.toLocaleString()} ØªÙˆÙ…Ø§Ù†</td>
    </tr>`;
  });
}

function renderHistory() {
  const tbody = document.getElementById('history-body');
  tbody.innerHTML = '';
  history.slice().reverse().forEach(h => {
    const rowClass = h.type === 'Ø®Ø±ÛŒØ¯' ? 'bg-green-50' : 'bg-red-50';
    tbody.innerHTML += `<tr class="${rowClass}">
      <td class="p-2">${h.time}</td>
      <td>${h.coin}</td>
      <td>${h.type}</td>
      <td>${h.qty.toFixed(4)}</td>
      <td>${h.price.toLocaleString()}</td>
    </tr>`;
  });
}

function calculatePnL(name, price) {
  const records = history.filter(h => h.coin === name);
  let totalQty = 0, totalCost = 0;
  records.forEach(h => {
    if (h.type === 'Ø®Ø±ÛŒØ¯') {
      totalQty += h.qty;
      totalCost += h.qty * h.price;
    } else {
      totalQty -= h.qty;
      totalCost -= h.qty * h.price;
    }
  });
  return totalQty <= 0 ? 0 : Math.round((price * (wallet[name] || 0)) - totalCost);
}

function openModal(coin, price, buy) {
  currentCoin = coin;
  currentPrice = price;
  isBuy = buy;
  document.getElementById('modal').classList.remove('hidden');
  document.getElementById('modal-title').textContent = `${buy ? 'Ø®Ø±ÛŒØ¯' : 'ÙØ±ÙˆØ´'} ${coin}`;
  document.getElementById('modal-input').value = '';
  document.getElementById('modal-extra').textContent = '';
  document.getElementById('modal-note').classList.add('hidden');
}

document.getElementById('percent-slider').oninput = e => {
  const percent = parseInt(e.target.value);
  if (isBuy) {
    const val = Math.floor((balance * percent) / 100);
    const qty = val / currentPrice;
    document.getElementById('modal-input').value = val;
    document.getElementById('modal-extra').textContent = `Ù…Ù‚Ø¯Ø§Ø± Ø®Ø±ÛŒØ¯: ${qty.toFixed(6)} ${currentCoin}`;
  } else {
    const qty = (wallet[currentCoin] || 0) * percent / 100;
    const val = qty * currentPrice;
    document.getElementById('modal-input').value = qty.toFixed(6);
    document.getElementById('modal-extra').textContent = `Ø¯Ø±ÛŒØ§ÙØªÛŒ: ${val.toLocaleString()} ØªÙˆÙ…Ø§Ù†`;
  }
};

function closeModal() {
  document.getElementById('modal').classList.add('hidden');
}

function confirmModal() {
  const val = parseFloat(document.getElementById('modal-input').value);
  if (!val || val <= 0) return;

  if (isBuy) {
    if (val < 100000) {
      document.getElementById('modal-note').classList.remove('hidden');
      setTimeout(() => document.getElementById('modal-note').classList.add('hidden'), 3000);
      return;
    }
    if (val > balance) return alert('Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª');
    const qty = val / currentPrice;
    wallet[currentCoin] = (wallet[currentCoin] || 0) + qty;
    balance -= val;
    history.push({ time: new Date().toLocaleTimeString('fa-IR'), coin: currentCoin, type: 'Ø®Ø±ÛŒØ¯', qty, price: currentPrice });
  } else {
    const owned = wallet[currentCoin] || 0;
    if (val > owned) return alert('Ù…Ù‚Ø¯Ø§Ø± Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´ Ù†Ø¯Ø§Ø±ÛŒØ¯');
    const total = val * currentPrice;
    wallet[currentCoin] -= val;
    balance += total;
    history.push({ time: new Date().toLocaleTimeString('fa-IR'), coin: currentCoin, type: 'ÙØ±ÙˆØ´', qty: val, price: currentPrice });
    if (wallet[currentCoin] <= 0) delete wallet[currentCoin];
  }

  saveAll(); renderWallet(); renderHistory(); closeModal();
}

function saveAll() {
  localStorage.setItem('wallet', JSON.stringify(wallet));
  localStorage.setItem('balance', balance);
  localStorage.setItem('history', JSON.stringify(history));
}

function showResetConfirm() {
  document.getElementById("confirm-reset-box").classList.remove("hidden");
}
function closeConfirmReset() {
  document.getElementById("confirm-reset-box").classList.add("hidden");
}
function confirmReset() {
  history = [];
  saveAll();
  renderHistory();
  closeConfirmReset();
}

setInterval(() => {
  coins.forEach(c => {
    const rand = 1 + (Math.random() - 0.5) * 0.01;
    c.price = Math.round(c.price * rand);
  });
  applyTimeBasedFluctuation();
renderMarket();
  renderWallet();
}, 5000);

applyTimeBasedFluctuation();
renderMarket();
renderWallet();
renderHistory();
</script>
</body>
</html>
