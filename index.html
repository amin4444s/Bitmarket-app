
<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>بیت مارکت - شبیه‌ساز صرافی</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-sm font-sans">

<header class="bg-gray-800 text-white flex justify-between items-center px-4 py-2">
  <h1 class="text-lg font-bold">صرافی بیت مارکت</h1>
  <button onclick="toggleProfile()" class="w-8 h-8 rounded-full bg-white text-gray-800 flex items-center justify-center font-bold text-sm">👤</button>
</header>


<div id="profileBox" class="hidden fixed top-16 right-4 bg-white border shadow-xl rounded-xl w-80 p-4 z-50 text-sm">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-lg font-bold text-gray-800">اطلاعات حساب کاربری</h2>
    <button onclick="toggleProfile()" class="text-gray-400 hover:text-red-500 text-lg font-semibold">✖</button>
  </div>
  <div class="grid grid-cols-2 gap-4 text-gray-700">
    <div class="bg-gray-50 p-3 rounded shadow-sm">
      <div class="text-xs text-gray-500">نام کاربر</div>
      <div class="font-medium">کاربر صرافی</div>
    </div>
    <div class="bg-gray-50 p-3 rounded shadow-sm">
      <div class="text-xs text-gray-500">وضعیت ورود</div>
      <div class="font-medium">وارد شده</div>
    </div>
    <div class="bg-gray-50 p-3 rounded shadow-sm col-span-2">
      <div class="text-xs text-gray-500">موجودی کل (تومان)</div>
      <div class="font-bold text-green-700 text-lg" id="balanceToman">0</div>
    </div>
    <div class="bg-gray-50 p-3 rounded shadow-sm col-span-2">
      <div class="text-xs text-gray-500">موجودی دلاری</div>
      <div class="font-medium" id="balanceDollar">0 دلار</div>
    </div>
    <div class="bg-gray-50 p-3 rounded shadow-sm">
      <div class="text-xs text-gray-500">تعداد معاملات</div>
      <div class="font-medium" id="tradeCount">0</div>
    </div>
    <div class="bg-gray-50 p-3 rounded shadow-sm">
      <div class="text-xs text-gray-500">سود و زیان</div>
      <div class="font-medium" id="totalPnL">0</div>
    </div>
  </div>
</div>


<div class="p-4">
  <h2 class="font-semibold mb-2 text-gray-800">بازار لحظه‌ای</h2>
  <table class="w-full bg-white rounded shadow text-center">
    <thead class="bg-gray-100"><tr><th class="p-2">ارز</th><th>قیمت</th><th>عملیات</th></tr></thead>
    <tbody id="market-body"></tbody>
  </table>
</div>

<div class="p-4">
  <h2 class="font-semibold mb-2 text-gray-800">دارایی‌های من</h2>
  <table class="w-full bg-white rounded shadow text-center">
    <thead class="bg-gray-100"><tr><th>ارز</th><th>مقدار</th><th>ارزش تومانی</th><th>سود و زیان</th></tr></thead>
    <tbody id="wallet-body"></tbody>
  </table>
</div>

<div class="p-4">
  <div class="flex justify-between mb-2">
    <h2 class="font-semibold text-gray-800">دفتر معاملات</h2>
    <button onclick="showResetConfirm()" class="bg-gray-200 px-2 py-1 rounded text-xs">ریست</button>
  </div>
  <table class="w-full bg-white rounded shadow text-center">
    <thead class="bg-gray-100"><tr><th>زمان</th><th>ارز</th><th>نوع</th><th>مقدار</th><th>قیمت</th></tr></thead>
    <tbody id="history-body"></tbody>
  </table>
</div>

<!-- Modal خرید/فروش -->
<div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-50">
  <div class="bg-white p-4 rounded w-80">
    <h3 id="modal-title" class="text-lg font-semibold mb-2"></h3>
    <input id="modal-input" type="number" class="w-full border p-2 rounded mb-2" placeholder="مقدار یا مبلغ">
    <input id="percent-slider" type="range" min="1" max="100" class="w-full mb-1">
    <p id="modal-extra" class="text-xs text-gray-600 mb-1"></p>
    <p id="modal-note" class="text-xs text-red-600 mb-1 hidden">حداقل مبلغ خرید ۱۰۰,۰۰۰ تومان است</p>
    <div class="flex justify-between gap-2">
      <button onclick="confirmModal()" class="bg-green-500 text-white px-4 py-1 rounded w-full">تأیید</button>
      <button onclick="closeModal()" class="bg-gray-200 text-gray-800 px-4 py-1 rounded w-full">لغو</button>
    </div>
  </div>
</div>

<!-- پنل ریست دفتر معاملات -->
<div id="confirm-reset-box" class="hidden fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-50">
  <div class="bg-white p-4 rounded shadow w-72">
    <p class="text-sm text-gray-800 mb-4">آیا مطمئن هستید که می‌خواهید دفتر معاملات را ریست کنید؟</p>
    <div class="flex gap-2">
      <button onclick="confirmReset()" class="bg-red-500 text-white w-full rounded py-1">بله</button>
      <button onclick="closeConfirmReset()" class="bg-gray-200 text-gray-800 w-full rounded py-1">لغو</button>
    </div>
  </div>
</div>

<script>
const coins = [
  { name: 'BTC', price: 6000000000 },
  { name: 'ETH', price: 300000000 },
  { name: 'USDT', price: 80000 },
  { name: 'XRP', price: 300000 }
];

function simulateTimeBasedFluctuation() {
  for (let c of coins) {
    const rand = 1 + (Math.random() - 0.5) * 0.02; // ±2% نوسان
    c.price = Math.round(c.price * rand);
  }
}

function applyTimeBasedFluctuation() {
  const lastVisit = Number(localStorage.getItem('lastVisit')) || Date.now();
  const now = Date.now();
  const minutesPassed = Math.floor((now - lastVisit) / 60000);
  for (let i = 0; i < minutesPassed; i++) {
    simulateTimeBasedFluctuation();
  }
  localStorage.setItem('lastVisit', now);
}


let wallet = JSON.parse(localStorage.getItem('wallet') || '{}');
let history = JSON.parse(localStorage.getItem('history') || '[]');
let balance = Number(localStorage.getItem('balance') || 100000000);
let isBuy = true, currentCoin = '', currentPrice = 0;

function toggleProfile() {
  const box = document.getElementById('profileBox');
  box.classList.toggle('hidden');
  if (!box.classList.contains('hidden')) {
    const usdt = coins.find(c => c.name === 'USDT').price;
    const totalPnL = coins.reduce((acc, c) => acc + calculatePnL(c.name, c.price), 0);
    document.getElementById('balanceToman').textContent = balance.toLocaleString();
    document.getElementById('balanceDollar').textContent = (balance / usdt).toFixed(2);
    document.getElementById('tradeCount').textContent = history.length;
    document.getElementById('totalPnL').textContent =
      (totalPnL >= 0 ? '+' : '') + totalPnL.toLocaleString() + ' تومان';
  }
}

function renderMarket() {
  const tbody = document.getElementById('market-body');
  tbody.innerHTML = '';
  coins.forEach(c => {
    tbody.innerHTML += `<tr>
      <td class="p-2">${c.name}</td>
      <td>${c.price.toLocaleString()}</td>
      <td>
        <button onclick="openModal('${c.name}', ${c.price}, true)" class="bg-green-500 text-white text-xs px-3 py-1 rounded">خرید</button>
        <button onclick="openModal('${c.name}', ${c.price}, false)" class="bg-red-500 text-white text-xs px-3 py-1 rounded">فروش</button>
      </td>
    </tr>`;
  });
}

function renderWallet() {
  const tbody = document.getElementById('wallet-body');
  tbody.innerHTML = '';
  coins.forEach(c => {
    const qty = wallet[c.name] || 0;
    const value = qty * c.price;
    const pnl = calculatePnL(c.name, c.price);
    const pnlColor = pnl > 0 ? 'text-green-600' : pnl < 0 ? 'text-red-600' : '';
    tbody.innerHTML += `<tr>
      <td class="p-2">${c.name}</td>
      <td>${qty.toFixed(4)}</td>
      <td>${value.toLocaleString()} تومان</td>
      <td class="${pnlColor}">${pnl >= 0 ? '+' : ''}${pnl.toLocaleString()} تومان</td>
    </tr>`;
  });
}

function renderHistory() {
  const tbody = document.getElementById('history-body');
  tbody.innerHTML = '';
  history.slice().reverse().forEach(h => {
    const rowClass = h.type === 'خرید' ? 'bg-green-50' : 'bg-red-50';
    tbody.innerHTML += `<tr class="${rowClass}">
      <td class="p-2">${h.time}</td>
      <td>${h.coin}</td>
      <td>${h.type}</td>
      <td>${h.qty.toFixed(4)}</td>
      <td>${h.price.toLocaleString()}</td>
    </tr>`;
  });
}

function calculatePnL(name, price) {
  const records = history.filter(h => h.coin === name);
  let totalQty = 0, totalCost = 0;
  records.forEach(h => {
    if (h.type === 'خرید') {
      totalQty += h.qty;
      totalCost += h.qty * h.price;
    } else {
      totalQty -= h.qty;
      totalCost -= h.qty * h.price;
    }
  });
  return totalQty <= 0 ? 0 : Math.round((price * (wallet[name] || 0)) - totalCost);
}

function openModal(coin, price, buy) {
  currentCoin = coin;
  currentPrice = price;
  isBuy = buy;
  document.getElementById('modal').classList.remove('hidden');
  document.getElementById('modal-title').textContent = `${buy ? 'خرید' : 'فروش'} ${coin}`;
  document.getElementById('modal-input').value = '';
  document.getElementById('modal-extra').textContent = '';
  document.getElementById('modal-note').classList.add('hidden');
}

document.getElementById('percent-slider').oninput = e => {
  const percent = parseInt(e.target.value);
  if (isBuy) {
    const val = Math.floor((balance * percent) / 100);
    const qty = val / currentPrice;
    document.getElementById('modal-input').value = val;
    document.getElementById('modal-extra').textContent = `مقدار خرید: ${qty.toFixed(6)} ${currentCoin}`;
  } else {
    const qty = (wallet[currentCoin] || 0) * percent / 100;
    const val = qty * currentPrice;
    document.getElementById('modal-input').value = qty.toFixed(6);
    document.getElementById('modal-extra').textContent = `دریافتی: ${val.toLocaleString()} تومان`;
  }
};

function closeModal() {
  document.getElementById('modal').classList.add('hidden');
}

function confirmModal() {
  const val = parseFloat(document.getElementById('modal-input').value);
  if (!val || val <= 0) return;

  if (isBuy) {
    if (val < 100000) {
      document.getElementById('modal-note').classList.remove('hidden');
      setTimeout(() => document.getElementById('modal-note').classList.add('hidden'), 3000);
      return;
    }
    if (val > balance) return alert('موجودی کافی نیست');
    const qty = val / currentPrice;
    wallet[currentCoin] = (wallet[currentCoin] || 0) + qty;
    balance -= val;
    history.push({ time: new Date().toLocaleTimeString('fa-IR'), coin: currentCoin, type: 'خرید', qty, price: currentPrice });
  } else {
    const owned = wallet[currentCoin] || 0;
    if (val > owned) return alert('مقدار کافی برای فروش ندارید');
    const total = val * currentPrice;
    wallet[currentCoin] -= val;
    balance += total;
    history.push({ time: new Date().toLocaleTimeString('fa-IR'), coin: currentCoin, type: 'فروش', qty: val, price: currentPrice });
    if (wallet[currentCoin] <= 0) delete wallet[currentCoin];
  }

  saveAll(); renderWallet(); renderHistory(); closeModal();
}

function saveAll() {
  localStorage.setItem('wallet', JSON.stringify(wallet));
  localStorage.setItem('balance', balance);
  localStorage.setItem('history', JSON.stringify(history));
}

function showResetConfirm() {
  document.getElementById("confirm-reset-box").classList.remove("hidden");
}
function closeConfirmReset() {
  document.getElementById("confirm-reset-box").classList.add("hidden");
}
function confirmReset() {
  history = [];
  saveAll();
  renderHistory();
  closeConfirmReset();
}

setInterval(() => {
  coins.forEach(c => {
    const rand = 1 + (Math.random() - 0.5) * 0.01;
    c.price = Math.round(c.price * rand);
  });
  applyTimeBasedFluctuation();
renderMarket();
  renderWallet();
}, 5000);

applyTimeBasedFluctuation();
renderMarket();
renderWallet();
renderHistory();
</script>
</body>
</html>
